#$1 List of Sim.vbf or Sim.root files
#$2 VegasProduction file name: 
#       EX: VegasProductionStdCuts.scr
#$3 Job designator (ex A)
#$4 Alternate VEGAS path (optional)
#$5 PedVar file (optional)

function usage()
{
 echo '***ProcessVegasSim usage:'
 echo '   $1:  List of Sim.vbf or Sim.root files'
 echo '   $2:  VegasProduction file name: Ex: VegasSimProductionStdCuts.scr'
 echo '   $3:  Job designator. Ex "A" or "B5" or "MyVeryFavoriteJob"'
 echo '   $4:  Vegas Version (optional) Ex: 2.5.4 or 2.5.5M '
 echo '   $5:  PedVar file name (optional and $4 must be specified )Ex: PedUA5.18 '
 echo ' EX: ./ProcessVegasSim 745677.vbf VegasSimProductionStdCuts.scr A1 2.5.5M PedNA6.44 '
 echo '***'
}

if [ ! -n "$3" ]; then
   usage
   exit
fi

##################
# Bring in Utility Functions(like:SetupForHost SgeFilePBSCmds SgeFileBashCmds )
##################
if [ ! -e UtilityFunctions.scr ]; then
    cp $KASCADEBASE/scripts/UtilityFunctions.scr ./
fi
source UtilityFunctions.scr

RUNLIST=$1
VEGASSIMPRODFILENAME=$2
JOBDESIGNATOR=$3
VEGASVERSION=$4
PEDVARFILENAME=$5

module unload vegas
module load vegas/$VEGASVERSION   #if VEGASVERSION not specified this just 
module li                         #loads default vegas

lcl="$PWD"

SetupForHost    #From UtilityFunctions.scr:Specifics for cluster we are on

let i=0
if [ -n "$PURDUE" ]; then
  #Defualt is Physics queue with 10 hr walltime.
  WALLTIME=30:00:00  #Extend WALLTIME from default
  #QUEUE=QUEUE2           #Standby queue
  #WALLTIME=04:00:00
fi

{
 while read DataFile  ; do
   BaseFileName=${DataFile##/*/}
   ####################################################################
   # Make up the job script file that will be submitted below
   ####################################################################
   sgeFile=$lcl'/'$BaseFileName$JOBDESIGNATOR'.pbs'
      
   SgeFilePBSCmds $sgeFile   # In UtilityFunictions.scr: 
                             # Adds PBS or SBATCH commands to "pbs" files

   SgeFileBashCmds $sgeFile  # In UtilityFunictions.scr:
                             # Adds Batch commands to "pbs" files

   echo module unload vegas                          >>$sgeFile
   echo module load vegas/$VEGASVERSION              >>$sgeFile
   echo module list                                  >>$sgeFile
   echo cd $lcl                                      >>$sgeFile
 
   echo $lcl'/'$VEGASSIMPRODFILENAME  \\             >>$sgeFile
   echo $DataFile' '  \\                             >>$sgeFile
   if test -n "$PEDVARFILENAME"
    then
     echo $PEDVARFILENAME  \\                        >>$sgeFile
     if test -n "$5"
      then  
       echo $5  \\                                   >>$sgeFile
     fi 
   fi 
   echo ' >'$lcl'/'$BaseFileName$JOBDESIGNATOR'.log' >>$sgeFile

   chmod 700 $sgeFile

   $QSUB -e 'W'$JOBDESIGNATOR$BaseFileName'.err' -o 'W'$JOBDESIGNATOR$BaseFileName'.log' $sgeFile

  done
}<$RUNLIST


